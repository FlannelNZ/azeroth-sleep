#!/bin/bash

TARGET_IP=$1
TARGET_PORT=$2
BIN_PATH=$3

input_data=$(dd bs=1 if=/dev/stdin 2>/dev/null)

echo "Received data: $(echo "$input_data" | hexdump -C)" >&2

# Log with timestamp
log_message() {
    logger -t azeroth-proxy "$1"
    echo "$(date '+%Y-%m-%d %H:%M:%S'): $1" >&2
}

log_message "New connection received: $input_data"

# Thaw servers
auth_pid=$(pgrep -f "${BIN_PATH}/authserver")
world_pid=$(pgrep -f "${BIN_PATH}/worldserver")

if [ -n "$auth_pid" ] && ps -o state= -p "$auth_pid" | grep -q "T"; then
    log_message "Thawing auth server (PID: $auth_pid)"
    kill -CONT "$auth_pid"
fi

if [ -n "$world_pid" ] && ps -o state= -p "$world_pid" | grep -q "T"; then
    log_message "Thawing world server (PID: $world_pid)"
    kill -CONT "$world_pid"
fi

# Small delay to ensure servers are ready
sleep 0.5

# Forward the connection
log_message "Fwding to authserver..."
response=$(echo "$input_data" | nc $TARGET_IP $TARGET_PORT)

log_message "ÂRepsonse: $response"
echo $response 
